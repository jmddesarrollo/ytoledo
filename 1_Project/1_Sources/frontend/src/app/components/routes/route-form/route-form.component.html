<div class="route-form-container">
  <!-- Header -->
  <div class="w3-row w3-margin-bottom">
    <div class="w3-col l8 m8 s12">
      <h2>{{ isEditMode ? 'Editar Ruta' : 'Nueva Ruta' }}</h2>
    </div>
    <div class="w3-col l4 m4 s12 w3-right-align">
      <button class="w3-button w3-light-grey w3-round" (click)="onCancel()">
        <i class="fa fa-arrow-left"></i> Volver
      </button>
    </div>
  </div>

  <!-- Loading indicator -->
  <div *ngIf="loading" class="w3-center w3-padding">
    <i class="fa fa-spinner fa-spin fa-2x"></i>
    <p>Cargando ruta...</p>
  </div>

  <!-- Error message -->
  <div *ngIf="errorMessage" class="w3-panel w3-red w3-round w3-margin-bottom">
    <p><i class="fa fa-exclamation-triangle"></i> {{ errorMessage }}</p>
  </div>

  <!-- Form -->
  <div *ngIf="!loading" class="w3-card w3-white">
    <div class="w3-container w3-padding">
      <form [formGroup]="routeForm" (ngSubmit)="onSubmit()">
        
        <!-- Información básica -->
        <div class="form-section">
          <h4 class="section-title">Información Básica</h4>
          
          <div class="w3-row-padding">
            <!-- Nombre -->
            <div class="w3-col l6 m6 s12">
              <label class="field-label">Nombre de la Ruta *</label>
              <input 
                class="w3-input w3-border w3-round"
                [ngClass]="{'w3-border-red': isFieldInvalid('name')}"
                type="text" 
                formControlName="name"
                [disabled]="isFormDisabled"
                placeholder="Ej: Ruta del Pinar">
              <div *ngIf="isFieldInvalid('name')" class="error-message">
                {{ getFieldError('name') }}
              </div>
            </div>

            <!-- Fecha -->
            <div class="w3-col l6 m6 s12">
              <label class="field-label">Fecha *</label>
              <input 
                class="w3-input w3-border w3-round"
                [ngClass]="{'w3-border-red': isFieldInvalid('date')}"
                type="date" 
                formControlName="date"
                [disabled]="isFormDisabled">
              <div *ngIf="isFieldInvalid('date')" class="error-message">
                {{ getFieldError('date') }}
              </div>
            </div>
          </div>

          <div class="w3-row-padding">
            <!-- Punto de inicio -->
            <div class="w3-col l6 m6 s12">
              <label class="field-label">Punto de Inicio *</label>
              <input 
                class="w3-input w3-border w3-round"
                [ngClass]="{'w3-border-red': isFieldInvalid('start_point')}"
                type="text" 
                formControlName="start_point"
                [disabled]="isFormDisabled"
                placeholder="Ej: Plaza del pueblo">
              <div *ngIf="isFieldInvalid('start_point')" class="error-message">
                {{ getFieldError('start_point') }}
              </div>
            </div>

            <!-- Dificultad -->
            <div class="w3-col l6 m6 s12">
              <label class="field-label">Dificultad *</label>
              <select 
                class="w3-select w3-border w3-round"
                [ngClass]="{'w3-border-red': isFieldInvalid('difficulty')}"
                formControlName="difficulty"
                [disabled]="isFormDisabled">
                <option *ngFor="let diff of difficulties" [value]="diff.value">
                  {{ diff.label }}
                </option>
              </select>
              <div *ngIf="isFieldInvalid('difficulty')" class="error-message">
                {{ getFieldError('difficulty') }}
              </div>
            </div>
          </div>

          <!-- Descripción -->
          <div class="w3-row-padding">
            <div class="w3-col s12">
              <label class="field-label">Descripción</label>
              <textarea 
                class="w3-input w3-border w3-round"
                [ngClass]="{'w3-border-red': isFieldInvalid('description')}"
                formControlName="description"
                [disabled]="isFormDisabled"
                rows="4"
                placeholder="Describe la ruta, puntos de interés, características especiales..."></textarea>
              <div *ngIf="isFieldInvalid('description')" class="error-message" 
                   [ngClass]="{'warning-message': routeForm.get('description')?.errors?.['containsEmojis']}">
                {{ getFieldError('description') }}
              </div>
              <small class="field-help">
                Evita usar emojis o caracteres especiales que puedan causar problemas de codificación
              </small>
            </div>
          </div>
        </div>

        <!-- Características técnicas -->
        <div class="form-section">
          <h4 class="section-title">Características Técnicas</h4>
          
          <div class="w3-row-padding">
            <!-- Distancia km -->
            <div class="w3-col l3 m6 s12">
              <label class="field-label">Distancia (km) *</label>
              <input 
                class="w3-input w3-border w3-round"
                [ngClass]="{'w3-border-red': isFieldInvalid('distance_km')}"
                type="number" 
                step="0.1"
                min="0"
                formControlName="distance_km"
                placeholder="0.0">
              <div *ngIf="isFieldInvalid('distance_km')" class="error-message">
                {{ getFieldError('distance_km') }}
              </div>
            </div>

            <!-- Distancia metros -->
            <div class="w3-col l3 m6 s12">
              <label class="field-label">Distancia (m) *</label>
              <input 
                class="w3-input w3-border w3-round"
                [ngClass]="{'w3-border-red': isFieldInvalid('distance_m')}"
                type="number" 
                min="1"
                formControlName="distance_m"
                placeholder="0">
              <div *ngIf="isFieldInvalid('distance_m')" class="error-message">
                {{ getFieldError('distance_m') }}
              </div>
            </div>

            <!-- Tipo de ruta -->
            <div class="w3-col l3 m6 s12">
              <label class="field-label">Tipo de Ruta *</label>
              <select 
                class="w3-select w3-border w3-round"
                [ngClass]="{'w3-border-red': isFieldInvalid('type')}"
                formControlName="type">
                <option *ngFor="let type of routeTypes" [value]="type.value">
                  {{ type.label }}
                </option>
              </select>
              <div *ngIf="isFieldInvalid('type')" class="error-message">
                {{ getFieldError('type') }}
              </div>
            </div>

            <!-- Desnivel positivo -->
            <div class="w3-col l3 m6 s12">
              <label class="field-label">Desnivel Positivo (m) *</label>
              <input 
                class="w3-input w3-border w3-round"
                [ngClass]="{'w3-border-red': isFieldInvalid('elevation_gain')}"
                type="number" 
                min="0"
                formControlName="elevation_gain"
                placeholder="0">
              <div *ngIf="isFieldInvalid('elevation_gain')" class="error-message">
                {{ getFieldError('elevation_gain') }}
              </div>
            </div>
          </div>

          <div class="w3-row-padding">
            <!-- Duración horas -->
            <div class="w3-col l3 m6 s12">
              <label class="field-label">Duración Horas *</label>
              <input 
                class="w3-input w3-border w3-round"
                [ngClass]="{'w3-border-red': isFieldInvalid('estimated_duration_hours')}"
                type="number" 
                min="0"
                max="23"
                formControlName="estimated_duration_hours"
                placeholder="0">
              <div *ngIf="isFieldInvalid('estimated_duration_hours')" class="error-message">
                {{ getFieldError('estimated_duration_hours') }}
              </div>
            </div>

            <!-- Duración minutos -->
            <div class="w3-col l3 m6 s12">
              <label class="field-label">Duración Minutos *</label>
              <input 
                class="w3-input w3-border w3-round"
                [ngClass]="{'w3-border-red': isFieldInvalid('estimated_duration_minutes')}"
                type="number" 
                min="0"
                max="59"
                formControlName="estimated_duration_minutes"
                placeholder="0">
              <div *ngIf="isFieldInvalid('estimated_duration_minutes')" class="error-message">
                {{ getFieldError('estimated_duration_minutes') }}
              </div>
            </div>

            <!-- Altura máxima -->
            <div class="w3-col l3 m6 s12">
              <label class="field-label">Altura Máxima (m) *</label>
              <input 
                class="w3-input w3-border w3-round"
                [ngClass]="{'w3-border-red': isFieldInvalid('max_height')}"
                type="number" 
                min="0"
                formControlName="max_height"
                placeholder="0">
              <div *ngIf="isFieldInvalid('max_height')" class="error-message">
                {{ getFieldError('max_height') }}
              </div>
            </div>

            <!-- Altura mínima -->
            <div class="w3-col l3 m6 s12">
              <label class="field-label">Altura Mínima (m) *</label>
              <input 
                class="w3-input w3-border w3-round"
                [ngClass]="{'w3-border-red': isFieldInvalid('min_height')}"
                type="number" 
                min="0"
                formControlName="min_height"
                placeholder="0">
              <div *ngIf="isFieldInvalid('min_height')" class="error-message">
                {{ getFieldError('min_height') }}
              </div>
            </div>
          </div>
        </div>

        <!-- Enlaces adicionales -->
        <div class="form-section">
          <h4 class="section-title">Enlaces y Archivos</h4>
          
          <!-- File attachment section -->
          <div class="w3-row-padding">
            <div class="w3-col s12">
              <label class="field-label">Archivo Adjunto</label>
              <app-file-attachment
                [currentFile]="attachedFile"
                [disabled]="isFormDisabled"
                [maxFileSize]="5242880"
                [acceptedTypes]="acceptedFileTypes"
                (fileAttached)="onFileAttached($event)"
                (fileRemoved)="onFileRemoved()">
              </app-file-attachment>
              <small class="field-help">
                Adjunta un archivo de track de senderismo: GPX (recomendado), KML o KMZ
              </small>
            </div>
          </div>
          
          <div class="w3-row-padding">
            <!-- Enlace de inscripción -->
            <div class="w3-col s12">
              <label class="field-label">Enlace de Inscripción</label>
              <input 
                class="w3-input w3-border w3-round"
                [ngClass]="{'w3-border-red': isFieldInvalid('sign_up_link')}"
                type="url" 
                formControlName="sign_up_link"
                [disabled]="isFormDisabled"
                placeholder="https://...">
              <div *ngIf="isFieldInvalid('sign_up_link')" class="error-message">
                {{ getFieldError('sign_up_link') }}
              </div>
            </div>
          </div>

          <div class="w3-row-padding">
            <!-- Enlace Wikiloc -->
            <div class="w3-col s12">
              <label class="field-label">Enlace Wikiloc</label>
              <input 
                class="w3-input w3-border w3-round"
                [ngClass]="{'w3-border-red': isFieldInvalid('wikiloc_link')}"
                type="url" 
                formControlName="wikiloc_link"
                [disabled]="isFormDisabled"
                placeholder="https://wikiloc.com/...">
              <div *ngIf="isFieldInvalid('wikiloc_link')" class="error-message">
                {{ getFieldError('wikiloc_link') }}
              </div>
            </div>
          </div>

          <div class="w3-row-padding">

            <!-- Enlace mapa Wikiloc -->
            <div class="w3-col s12">
              <label class="field-label">Código Iframe Mapa Wikiloc</label>
              <textarea 
                class="w3-input w3-border w3-round"
                [ngClass]="{'w3-border-red': isFieldInvalid('wikiloc_map_link')}"
                formControlName="wikiloc_map_link"
                [disabled]="isFormDisabled"
                rows="4"
                placeholder="<iframe frameBorder=&quot;0&quot; scrolling=&quot;no&quot; src=&quot;https://es.wikiloc.com/wikiloc/embedv2.do?id=17328354&elevation=on&images=off&maptype=H&quot; width=&quot;600&quot; height=&quot;500&quot;></iframe>">
              </textarea>
              <div *ngIf="isFieldInvalid('wikiloc_map_link')" class="error-message">
                {{ getFieldError('wikiloc_map_link') }}
              </div>
              <small class="field-help">
                Pega aquí el código iframe que proporciona Wikiloc para embeber el mapa de la ruta
              </small>
            </div>
          </div>
        </div>

        <!-- Botones de acción -->
        <div class="form-actions">
          <div class="w3-row-padding">
            <div class="w3-col l6 m6 s12">
              <button 
                type="button" 
                class="w3-button w3-light-grey w3-round w3-block"
                (click)="onCancel()"
                [disabled]="isFormDisabled">
                <i class="fa fa-times"></i> Cancelar
              </button>
            </div>
            <div class="w3-col l6 m6 s12">
              <button 
                type="submit" 
                class="w3-button w3-blue w3-round w3-block"
                [disabled]="isFormDisabled || routeForm.invalid">
                <i *ngIf="saving" class="fa fa-spinner fa-spin"></i>
                <i *ngIf="!saving && !fileOperationInProgress" class="fa fa-save"></i>
                <i *ngIf="fileOperationInProgress" class="fa fa-file-upload"></i>
                {{ saving ? 'Guardando...' : (fileOperationInProgress ? 'Procesando archivo...' : (isEditMode ? 'Actualizar Ruta' : 'Crear Ruta')) }}
              </button>
            </div>
          </div>
        </div>

      </form>
    </div>
  </div>
</div>